{% extends 'core/base.html' %}
{% load i18n %}

{% block title %}{{ product.title }}{% endblock %}

{% block meta %}
<meta property="og:title" content="{{product.title}}" />
<meta property="og:description" content="{{ product.description }}" />
<meta property="og:image" content="{{ product.image.url }}" />
<meta
  property="og:url"
  content="{{ protocol }}://{{ domain }}{% url 'product_detail' product.category.slug product.subcategory.slug product.slug %}"
/>
{% endblock %}

{% block content %}

<style>
  /* Make media look clean and consistent */
  .media-frame {
    width: 100%;
    height: 520px;
    object-fit: contain;
    background: #0b0b0b;
    border-radius: 16px;
    display: block;
  }

  @media (max-width: 1024px) {
    .media-frame {
      height: 360px;
    }
  }

  @media (max-width: 500px) {
    .media-frame {
      height: 260px;
    }
  }

  video.media-frame {
    background: #0b0b0b;
  }
</style>

<div class="container mx-auto px-4 py-6">

  <!-- Breadcrumb -->
  <nav class="text-sm text-gray-600" aria-label="Breadcrumb">
    <ol class="flex flex-wrap items-center gap-2">
      <li class="flex items-center gap-2">
        <a href="{% url 'category_detail' category.slug %}" class="hover:text-gray-900">
          {{ category.title }}
        </a>
        <span class="text-gray-300">/</span>
      </li>

      <li class="flex items-center gap-2">
        <a href="{% url 'subcategory_detail' category.slug subcategory.slug %}" class="hover:text-gray-900">
          {{ subcategory.title }}
        </a>
        <span class="text-gray-300">/</span>
      </li>

      <li class="font-semibold text-gray-900">
        {{ product.title }}
      </li>
    </ol>
  </nav>

  <!-- Main layout -->
  <div class="mt-6 grid grid-cols-1 gap-6 lg:grid-cols-3">

    <!-- LEFT: Media -->
    <div class="lg:col-span-2 space-y-4">

      <!-- Carousel card -->
      <div class="rounded-2xl border border-gray-200 bg-white p-3 shadow-sm">
        <div
          id="carouselExampleFade"
          class="carousel slide carousel-fade overflow-hidden rounded-2xl"
          data-bs-ride="carousel"
        >
          <div class="carousel-inner">
            {% if product.image %}
              <div class="carousel-item active">
                <img src="{{ product.image.url }}" class="media-frame" alt="Product Image" />
              </div>
            {% else %}
              <div class="carousel-item active">
                <img src="{{ product.get_thumbnail }}" class="media-frame" alt="Product Thumbnail" />
              </div>
            {% endif %}

            {% if product.image_2 %}
              <div class="carousel-item">
                <img src="{{ product.image_2.url }}" class="media-frame" alt="Product Image2" />
              </div>
            {% endif %}

            {% if product.image_3 %}
              <div class="carousel-item">
                <img src="{{ product.image_3.url }}" class="media-frame" alt="Product Image3" />
              </div>
            {% endif %}

            {% if product.image_4 %}
              <div class="carousel-item">
                <img src="{{ product.image_4.url }}" class="media-frame" alt="Product Image4" />
              </div>
            {% endif %}
          </div>

          <!-- Controls -->
          <button
            class="carousel-control-prev"
            type="button"
            data-bs-target="#carouselExampleFade"
            data-bs-slide="prev"
          >
            <span class="carousel-control-prev-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Previous</span>
          </button>

          <button
            class="carousel-control-next"
            type="button"
            data-bs-target="#carouselExampleFade"
            data-bs-slide="next"
          >
            <span class="carousel-control-next-icon" aria-hidden="true"></span>
            <span class="visually-hidden">Next</span>
          </button>
        </div>
      </div>

      {% if product.video %}
        <!-- Video card -->
        <div class="rounded-2xl border border-gray-200 bg-white p-3 shadow-sm">
          <video
            id="carousel-video"
            class="media-frame"
            controls
            autoplay
            muted
            playsinline
          >
            <source src="{{ product.video.url }}" type="video/mp4" />
            Your browser does not support video.
          </video>
        </div>
      {% endif %}

      <!-- Description card (on left for better balance) -->
      <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm space-y-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <h2 class="text-lg font-extrabold text-gray-900">{% trans "Details" %}</h2>

          <p class="text-sm text-gray-600">
            {% trans "More from" %}:
            <a href="{% url 'vendor_detail' product.user.id %}" class="font-semibold text-teal-600 hover:underline">
              {{ product.user.username }}
            </a>
          </p>
        </div>

        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
          {% if product.brand %}
            <div class="rounded-xl bg-gray-50 p-3">
              <p class="text-xs font-bold text-gray-500">{% trans "Brand" %}</p>
              <p class="text-sm font-semibold text-gray-900">{{ product.brand }}</p>
            </div>
          {% endif %}

          {% if product.model %}
            <div class="rounded-xl bg-gray-50 p-3">
              <p class="text-xs font-bold text-gray-500">{% trans "Model" %}</p>
              <p class="text-sm font-semibold text-gray-900">{{ product.model }}</p>
            </div>
          {% endif %}

          {% if product.condition %}
            <div class="rounded-xl bg-gray-50 p-3">
              <p class="text-xs font-bold text-gray-500">{% trans "Condition" %}</p>
              <p class="text-sm font-semibold text-gray-900">{{ product.condition }}</p>
            </div>
          {% endif %}
        </div>

        {% if product.description %}
          <div>
            <p class="text-xs font-bold text-gray-500">{% trans "Description" %}</p>
            <p class="mt-2 whitespace-pre-wrap break-words text-sm text-gray-700">
              {{ product.description }}
            </p>
          </div>
        {% endif %}
      </div>

    </div>

    <!-- RIGHT: Sticky panel -->
    <div class="lg:sticky lg:top-6 space-y-4">

      <!-- Title + Price -->
      <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <h1 class="text-xl font-extrabold leading-snug text-gray-900">
          {{ product.title }}
        </h1>

        <p class="mt-2 text-2xl font-extrabold text-gray-900">
          ‚Ç¶{{ product.formatted_price }}
        </p>

        <div class="mt-3 flex items-center justify-between text-sm text-gray-600">
          <p class="flex items-center gap-2">
            <i class="fa fa-map-marker text-base"></i>
            <span>{{ owner_profile.lga }}, <span class="uppercase">{{ owner_profile.state }}</span></span>
          </p>
        </div>
      </div>

      <!-- Buttons -->
      <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <div class="grid grid-cols-1 gap-3">
          <button
            onclick="sharePage()"
            class="w-full rounded-xl bg-teal-500 px-4 py-3 text-sm font-bold text-white shadow-sm transition hover:bg-teal-600 active:scale-[0.99]"
          >
            Share
          </button>

          <a
            class="block"
            href="https://wa.me/{{ owner_profile.company_whatsapp_number }}?text=I%20am%20interested%20in%20this%20Item%20--%20{{ protocol }}%3A%2F%2F{{ domain }}{% url 'product_detail' product.category.slug product.subcategory.slug product.slug %}"
          >
            <button class="w-full rounded-xl bg-green-500 px-4 py-3 text-sm font-bold text-white shadow-sm transition hover:bg-green-600 active:scale-[0.99]">
              WhatsApp
            </button>
          </a>
        </div>

        <!-- Like + comment count -->
        <div class="mt-4 flex items-center justify-between rounded-xl bg-gray-50 p-3">
          <form
            method="post"
            action="{% url 'toggle_like' product.category.slug product.subcategory.slug product.slug %}"
            class="flex items-center gap-2"
          >
            {% csrf_token %}
            <button
              type="submit"
              class="inline-flex items-center gap-2 rounded-full border px-4 py-2 text-sm font-semibold transition hover:bg-white active:scale-[0.98]
                     {% if user in product.likes.all %}
                     border-rose-200 bg-rose-50 text-rose-600
                     {% else %}
                     border-gray-200 bg-white text-gray-700
                     {% endif %}"
            >
              <span class="text-base">
                {% if user in product.likes.all %} ‚ù§Ô∏è {% else %} ü§ç {% endif %}
              </span>
              
            </button>

            <span class="text-sm text-gray-500">
              {{ product.likes.count }} like{{ product.likes.count|pluralize }}
            </span>
          </form>

          <div class="rounded-full bg-white px-3 py-1 text-sm text-gray-700 border border-gray-200">
            üí¨ {{ product.comments.count }} comment{{ product.comments.count|pluralize }}
          </div>
        </div>
      </div>

      <!-- Comments -->
      <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm">
        <div class="flex items-center justify-between">
          <h4 class="text-sm font-extrabold text-gray-900">
            Comments ({{ product.comments.count }})
          </h4>
          {% if not product.comments_enabled %}
            <span class="text-xs font-semibold text-gray-500">Disabled</span>
          {% endif %}
        </div>

        {% if product.comments_enabled %}
          <form
            method="post"
            action="{% url 'add_comment' product.category.slug product.subcategory.slug product.slug %}"
            class="mt-3"
          >
            {% csrf_token %}
            <textarea
              name="comment"
              rows="3"
              placeholder="Write something..."
              class="w-full resize-none rounded-xl border border-gray-200 bg-gray-50 p-3 text-sm text-gray-800
                     outline-none focus:border-teal-400 focus:ring-2 focus:ring-teal-100"
            ></textarea>

            <div class="mt-3 flex items-center justify-between">
              <p class="text-xs text-gray-500">Be respectful.</p>
              <button
                type="submit"
                class="rounded-xl bg-teal-500 px-4 py-2 text-sm font-bold text-white shadow-sm transition hover:bg-teal-600 active:scale-[0.98]"
              >
                Post
              </button>
            </div>
          </form>
        {% else %}
          <p class="mt-3 text-sm text-gray-500">Comments are disabled for this product.</p>
        {% endif %}

        <div class="mt-4 space-y-3 max-h-80 overflow-y-auto pr-1">
          {% for comment in product.comments.all %}
            <div class="rounded-xl border border-gray-100 bg-gray-50 p-3">
              <div class="flex items-center justify-between">
                <p class="text-sm font-bold text-gray-900">{{ comment.user.username }}</p>
                <p class="text-xs text-gray-500">
                  {{ comment.created_at|date:"M d, Y" }} ‚Ä¢ {{ comment.created_at|time:"g:i A" }}
                </p>
              </div>
              <p class="mt-2 whitespace-pre-wrap break-words text-sm text-gray-700">
                {{ comment.text }}
              </p>
            </div>
          {% empty %}
            <div class="rounded-xl border border-dashed border-gray-200 p-4 text-center">
              <p class="text-sm text-gray-500">No comments yet.</p>
            </div>
          {% endfor %}
        </div>
      </div>

      <!-- Footer note -->
      <div class="rounded-2xl border border-gray-200 bg-white p-5 shadow-sm text-center">
        <p class="text-xs font-semibold text-gray-800">
          WHATSAPP/CONTACT US NAIJAKET: +2348136863259
        </p>
        <p class="mt-2 text-xs text-gray-600">
          FOR DESIGN AND DEVELOPMENT OF WEBSITES, ONLINE STORES, PHOTO AND VIDEO PROJECTS FOR ALL BUSINESS TYPES.
        </p>
      </div>

    </div>

  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    const video = document.getElementById("carousel-video");
    const carouselEl = document.getElementById("carouselExampleFade");

    if (carouselEl && typeof bootstrap !== "undefined") {
      const carousel = new bootstrap.Carousel(carouselEl, { interval: false });

      if (video) {
        video.muted = true;

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) video.play();
              else video.pause();
            });
          },
          { threshold: 0.5 }
        );

        observer.observe(video);

        video.addEventListener("ended", () => {
          carousel.next();
        });
      }
    }
  });

  function sharePage() {
    if (navigator.share) {
      navigator.share({ title: document.title, url: window.location.href });
    } else {
      alert("Your browser does not support sharing.");
    }
  }
</script>

{% endblock %}
